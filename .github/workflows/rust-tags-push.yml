name: Push Tags on Merge to Main

on:
  push:
    branches:
      - main

jobs:
  generate-and-push-tags:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
          fetch-depth: '0'

    - name: "checkout branch"
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          Cargo.toml
        sparse-checkout-cone-mode: false

    - name: Install cargo-binstall
      run: curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash

    - name: Install tq
      run: cargo binstall -y tomlq

    - name: "get version number for tag."
      run: |
        echo "NEW_TAG=$(tq -f Cargo.toml 'package.version')" | tee -a "$GITHUB_ENV"

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
      with:
        tag_name: ${{ env.NEW_TAG }}
        release_name: ${{ env.NEW_TAG }}
        draft: false
        prerelease: false
